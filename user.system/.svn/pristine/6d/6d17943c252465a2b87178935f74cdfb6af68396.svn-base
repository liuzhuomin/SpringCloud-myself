package xinrui.cloud.service.impl;

import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.Order;
import org.hibernate.criterion.Restrictions;
import org.springframework.stereotype.Service;
import org.springframework.util.Assert;
import xinrui.cloud.domain.TechnologyFinancialAppointment;
import xinrui.cloud.domain.dto.TechnologyFinancialAppointmentUserDto;
import xinrui.cloud.dto.PageDto;
import xinrui.cloud.service.TechnologyFinancialAppointmentService;

import java.util.Date;
import java.util.List;

/**
 * @author liuliuliu
 * @version 1.0
 * @date 2019/8/15 10:24
 */
@Service
public class TechnologyFinancialAppointmentServiceImpl extends BaseServiceImpl<TechnologyFinancialAppointment>
        implements TechnologyFinancialAppointmentService {

    @Override
    public PageDto<List<TechnologyFinancialAppointmentUserDto>> listAppointmentBank(Long id, int status, int currentPage, int pageSize) {
        DetachedCriteria technologyFinancialAppointmentCriteria = getCriteria(id);
        if (status == 0) {
            technologyFinancialAppointmentCriteria.add(Restrictions.isNotNull("processDate"));
        } else {
            technologyFinancialAppointmentCriteria.add(Restrictions.isNull("processDate"));
        }
        PageDto<List<TechnologyFinancialAppointment>> listPageDto = new PageDto<>(--currentPage * pageSize, pageSize, technologyFinancialAppointmentCriteria);
        dao.pageByCriteria(listPageDto);
        List<TechnologyFinancialAppointmentUserDto> t = TechnologyFinancialAppointmentUserDto.copy(listPageDto.getT());
        return new PageDto<List<TechnologyFinancialAppointmentUserDto>>(listPageDto.getTotalPage(), t);
    }

    private DetachedCriteria getCriteria(Long id) {
        return DetachedCriteria.forClass(TechnologyFinancialAppointment.class)
                .createAlias("technologyFinancial", "t")
                .add(Restrictions.eq("t.id", id)).addOrder(Order.asc("processDate"));
    }

    @Override
    public void processAppointment(Long bankId) {
        TechnologyFinancialAppointment byId = findById(bankId);
        Assert.notNull(byId, "找不到预约对象!");
        byId.setProcessDate(new Date());
        merge(byId);
    }

}
