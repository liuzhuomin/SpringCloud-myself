package liuzhuomin.cloud.config;

import com.google.common.base.Predicate;
import com.google.common.collect.Lists;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.PropertySource;
import springfox.documentation.RequestHandler;
import springfox.documentation.builders.*;
import springfox.documentation.schema.ModelRef;
import springfox.documentation.service.*;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spi.service.contexts.SecurityContext;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger.web.SecurityConfiguration;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

import java.io.UnsupportedEncodingException;
import java.net.UnknownHostException;
import java.util.ArrayList;
import java.util.Arrays;

@Configuration
@EnableSwagger2
@PropertySource({"classpath:application.properties"})
public class SwaggerConfig implements InitializingBean {

    private final static Logger LOGGER = LoggerFactory.getLogger(SwaggerConfig.class);

    @Value("${swagger.title: swaggerTitle}")
    private String swaggerTitle;

    @Value("${swagger.concatName: swaggerConcatName}")
    private String swaggerConcatName;

    @Value("${swagger.concatUrl:swaggerConcatUrl}")
    private String swaggerConcatUrl;

    @Value("${swagger.concatEmail:swaggerConcatEmail}")
    private String swaggerConcatEmail;

    @Value("${swagger.version:1.0}")
    private String swaggerVersion;

    @Value("${swagger.description: restfulAPI}")
    private String swaggerDescription;

    @Value("${swagger.basePackage:liuzhuomin}")
    private String swaggerBasePackage;

    @Value("${swagger.exportPath:/}")
    private String swaggerExportPath;

    @Value("${swagger.host:127.0.0.1:8080}")
    private String swaggerHost;

    @Bean
    public Docket createRestApi() throws UnknownHostException {
        ParameterBuilder tokenParameter = new ParameterBuilder();

        ArrayList<Parameter> parameters = Lists.newArrayList(tokenParameter.name("access_token").description("Token令牌")
                .modelRef(new ModelRef("String")).parameterType("header").required(false).build());

        ApiInfo build = new ApiInfoBuilder().title(iso2Utf8(swaggerTitle))
                .contact(new Contact(iso2Utf8(swaggerConcatName), iso2Utf8(swaggerConcatUrl), iso2Utf8(swaggerConcatEmail)))
                .version(iso2Utf8(swaggerVersion)).description(iso2Utf8(swaggerDescription)).build();

        Predicate<RequestHandler> basePackage = RequestHandlerSelectors.basePackage(swaggerBasePackage);

        Docket docket = new Docket(DocumentationType.SWAGGER_2).host(swaggerHost).apiInfo(build).select().apis(basePackage)
                .paths(PathSelectors.any()).build().globalOperationParameters(parameters);
        return docket;
    }

//    private SecurityScheme securityScheme() {
//        GrantType grantType = new AuthorizationCodeGrantBuilder()
//                .tokenEndpoint(new TokenEndpoint(AUTH_SERVER + "/token", "oauthtoken"))
//                .tokenRequestEndpoint(
//                        new TokenRequestEndpoint(AUTH_SERVER + "/authorize", CLIENT_ID, CLIENT_ID))
//                .build();
//
//        SecurityScheme oauth = new OAuthBuilder().name("spring_oauth")
//                .grantTypes(Arrays.asList(grantType))
//                .scopes(Arrays.asList(scopes()))
//                .build();
//        return oauth;
//    }
//
//    @Bean
//    public SecurityConfiguration security() {
//        return SecurityConfigurationBuilder.builder()
//                .clientId(CLIENT_ID)
//                .clientSecret(CLIENT_SECRET)
//                .scopeSeparator(" ")
//                .useBasicAuthenticationWithAccessCodeGrant(true)
//                .build();
//    }
//
//    private AuthorizationScope[] scopes() {
//        AuthorizationScope[] scopes = {
//                new AuthorizationScope("read", "for read operations"),
//                new AuthorizationScope("write", "for write operations"),
//                new AuthorizationScope("foo", "Access foo API")};
//        return scopes;
//    }
//
//    private SecurityContext securityContext() {
//        return SecurityContext.builder()
//                .securityReferences(Arrays.asList(new SecurityReference("spring_oauth", scopes())))
//                .forPaths(PathSelectors.regex("/foos.*"))
//                .build();
//    }

    /**
     * ISO-8859-1编码转换成utf-8编码
     *
     * @param str 需要被转换编码的字符串
     * @return 转换完成后的字符串
     */
    public static String iso2Utf8(String str) {
        try {
            return new String(str.getBytes("ISO-8859-1"), "UTF-8");
        } catch (UnsupportedEncodingException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
        return null;
    }

    @Override
    public void afterPropertiesSet() {
        LOGGER.info("swagger配置加载完成");
    }


}
