package xinrui.cloud.service.impl;

import com.google.common.collect.Lists;
import com.netflix.discovery.converters.Auto;
import lombok.extern.slf4j.Slf4j;
import org.hibernate.Criteria;
import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.Order;
import org.hibernate.criterion.Projections;
import org.hibernate.criterion.Restrictions;
import org.hibernate.sql.JoinType;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.Assert;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;
import xinrui.cloud.BootException;
import xinrui.cloud.common.utils.DateUtil;
import xinrui.cloud.compoment.Application;
import xinrui.cloud.domain.*;
import xinrui.cloud.domain.dto.*;
import xinrui.cloud.domain.vto.*;
import xinrui.cloud.dto.PageDto;
import xinrui.cloud.dto.UserDto;
import xinrui.cloud.service.TechnologyFinancialFileService;
import xinrui.cloud.service.TechnologyFinancialUserService;

import java.text.ParseException;
import java.util.Date;
import java.util.List;


@Service
@Slf4j
public class TechnologyFinancialServiceImpl extends BaseServiceImpl<TechnologyFinancial> implements xinrui.cloud.service.TechnologyFinancialService {

    @Autowired
    TechnologyFinancialFileService technologyFinancialFileService;

    @Autowired
    TechnologyFinancialUserService technologyFinancialUserService;

    @Override
    public List<TechnologyLoanDateDto> dates() {
        return TechnologyLoanDateDto.copy(dao.listObjBy(TechnologyLoanDate.class));
    }

    @Override
    public List<TechnologyLoanTypeDto> types() {
        return TechnologyLoanTypeDto.copy(dao.listObjBy(TechnologyLoanType.class));
    }

    @Override
    public List<TechnologyLoanAmountDto> amounts() {
        return TechnologyLoanAmountDto.copy(dao.listObjBy(TechnologyLoanAmount.class));
    }

    @Override
    public TechnologyFinancialDto saveByDto(TechnologyFinancialVto technologyFinancialVto) {

        checkDraftCount(technologyFinancialVto);

        TechnologyFinancial technologyFinancial = new TechnologyFinancial();

        checkProcessData(technologyFinancialVto, technologyFinancial);

        //申请条件
        List<TechnologyApplyCondition> technologyApplyConditions = TechnologyApplyConditionsVto.toBean(technologyFinancialVto.getTechnologyApplyConditions());
        technologyFinancial.getTechnologyApplyConditions().addAll(technologyApplyConditions);

        //办理流程
        List<TechnologyProcess> technologyProcesses = TechnologyProcessesVto.toBean(technologyFinancialVto.getTechnologyProcesses());
        technologyFinancial.getTechnologyProcesses().addAll(technologyProcesses);
        if (technologyProcesses.size() > 20) {
            throw new BootException("最多添加20条申请流程!");
        }

        //常见问题
        List<TechnologyUsualProblem> technologyUsualProblems = TechnologyUsualProblemsVto.toBean(technologyFinancialVto.getTechnologyUsualProblems());
        technologyFinancial.getTechnologyUsualProblems().addAll(technologyUsualProblems);
        if (technologyUsualProblems.size() > 5) {
            throw new BootException("最多添加5条问题!");
        }

        BeanUtils.copyProperties(technologyFinancialVto, technologyFinancial, "viewImages", "loanTimeLimit"
                , "loanAmount", "technologyApplyConditions", "technologyUsualProblems", "technologyProcesses", "applyEndDate");

        UserDto currentUser = Application.getCurrentUser();
        technologyFinancial.setUserId(currentUser.getId());
        technologyFinancial.setBank(currentUser.getUniqueGroup().getName());

        return TechnologyFinancialDto.copy(merge(technologyFinancial));

    }

    /**
     * 检查当前用户创建的位于草稿箱中的产品数量
     *
     * @param technologyFinancialVto
     */
    private void checkDraftCount(TechnologyFinancialVto technologyFinancialVto) {
        if (technologyFinancialVto.getStatus() == TechnologyFinancial.TechnologyStatus.DRAFT.value()) {
            DetachedCriteria countCriteria = DetachedCriteria.forClass(TechnologyFinancial.class)
                    .add(Restrictions.eq("userId", Application.getCurrentUser().getId()))
                    .add(Restrictions.eq("status", TechnologyFinancial.TechnologyStatus.DRAFT.value()));
            if (count(countCriteria) >= 20) {
                throw new BootException("草稿箱最多添加20条!");
            }
        }
    }

    @Override
    public List<TechnologyFinancialDto> publicById(Long id) {
        TechnologyFinancial byId = getTechnologyFinancialAndCheck(id);
        Integer status = byId.getStatus();
        if (status != TechnologyFinancial.TechnologyStatus.DRAFT.value()
                && status != TechnologyFinancial.TechnologyStatus.REFUSED.value()) {
            throw new BootException("只有被拒绝的产品或者草稿箱中的产品可以发布!");
        }
        byId.setStatus(TechnologyFinancial.TechnologyStatus.APPLYING.value());
        return drafts();
    }

    /**
     * 根据id获取产品对象{@link TechnologyFinancial}
     *
     * @param id {@link TechnologyFinancial#getId()}
     * @return {@link TechnologyFinancial}
     */
    private TechnologyFinancial getTechnologyFinancialAndCheck(Long id) {
        TechnologyFinancial byId = findById(id);
        Assert.notNull(byId, "科技金融产品对象找不到!");
        return byId;
    }

    @Override
    public List<TechnologyFinancialDto> drafts() {
        return listByStatus(TechnologyFinancial.TechnologyStatus.DRAFT.value());
    }

    @Override
    public TechnologyFinalAuditDto audits() {
        return new TechnologyFinalAuditDto(listByStatus(TechnologyFinancial.TechnologyStatus.REFUSED.value()),
                listByStatus(TechnologyFinancial.TechnologyStatus.APPLYING.value()));
    }

    @Override
    public TechnologyFinancialOnlineDto onlines() {

        DetachedCriteria statusCriteria = getDetachedCriteria(TechnologyFinancial.TechnologyStatus.ONLINE.value());
        statusCriteria.add(Restrictions.eq("category", TechnologyFinancial.TechnologyType.CREDIT_LOAN.value()));
        List<TechnologyFinancialDto> creditList = TechnologyFinancialDto.copy(listBydCriteria(statusCriteria));

        statusCriteria = getDetachedCriteria(TechnologyFinancial.TechnologyStatus.ONLINE.value());
        statusCriteria.add(Restrictions.eq("category", TechnologyFinancial.TechnologyType.MORTGAGES.value()));
        List<TechnologyFinancialDto> mortgagesList = TechnologyFinancialDto.copy(listBydCriteria(statusCriteria));

        return new TechnologyFinancialOnlineDto(creditList, mortgagesList);
    }

    @Override
    public PageDto<List<TechnologyFinancialGovDto>> audits(int status, String bank, int currentPage, int pageSize) {
        if (status != TechnologyFinancial.TechnologyStatus.APPLYING.value()
                && status != TechnologyFinancial.TechnologyStatus.ONLINE.value()) {
            throw new BootException("参数错误!");
        }
        DetachedCriteria statusCriteria = getStatusCriteria(status);
        if (!StringUtils.isEmpty(bank)) {
            statusCriteria.add(Restrictions.eq("bank", bank));
        }
        PageDto<List<TechnologyFinancial>> page = new PageDto<>(--currentPage * pageSize, pageSize, statusCriteria);
        dao.pageByCriteria(page);

        List<TechnologyFinancialGovDto> result = TechnologyFinancialGovDto.copy(page.getT());
        return new PageDto<List<TechnologyFinancialGovDto>>(page.getTotalPage(), result);
    }

    @Override
    public void audit(int id, TechnologyFinancial.TechnologyStatus status, String reason) {
        if (status != TechnologyFinancial.TechnologyStatus.ONLINE
                && status != TechnologyFinancial.TechnologyStatus.REFUSED
                && status != TechnologyFinancial.TechnologyStatus.OFFLINE) {
            throw new BootException("参数错误!");
        }
        TechnologyFinancial technologyFinancialAndCheck = getTechnologyFinancialAndCheck((long) id);
        if (status == TechnologyFinancial.TechnologyStatus.OFFLINE) {
            technologyFinancialAndCheck.setStatus(TechnologyFinancial.TechnologyStatus.REFUSED.value());
        } else {
            technologyFinancialAndCheck.setStatus(status.value());
            if (status == TechnologyFinancial.TechnologyStatus.REFUSED) {
                technologyFinancialAndCheck.setRefuseReason(reason);
            } else {
                technologyFinancialAndCheck.setRefuseReason(null);
            }

        }
        merge(technologyFinancialAndCheck);
    }

    @Override
    public void appointment(int id, TechnologyFinancialUserDto user) {

        Assert.notNull(user, "用户数据不能为空!");
        TechnologyFinancialUser technologyFinancialUser = new TechnologyFinancialUser();
        BeanUtils.copyProperties(user, technologyFinancialUser);

        TechnologyFinancial technologyFinancialAndCheck = getTechnologyFinancialAndCheck((long) id);
        technologyFinancialUser.setTechnologyFinancial(technologyFinancialAndCheck);
        technologyFinancialAndCheck.getTechnologyFinancialUsers().add(technologyFinancialUser);
        merge(technologyFinancialAndCheck);
    }

    @Override
    public PageDto<List<TechnologyFinancialBaseInfoDto>> onlines(Long amount, Long limit, String category, String name, int currentPage, int pageSize) {
        DetachedCriteria statusCriteria = getStatusCriteria(TechnologyFinancial.TechnologyStatus.ONLINE.value());
        if (amount != null) {
            statusCriteria.createAlias("loanAmount", "l", JoinType.INNER_JOIN).add(Restrictions.eq("l.id", amount));
        }
        if (limit != null) {
            statusCriteria.createAlias("loanTimeLimit", "loanTime", JoinType.INNER_JOIN).add(Restrictions.eq("loanTime.id", limit));
        }
        if (!StringUtils.isEmpty(category)) {
            checkTechnologyType(category);
            statusCriteria.add(Restrictions.eq("category", category));
        }
        if (!StringUtils.isEmpty(name)) {
            statusCriteria.add(Restrictions.like("name", "%" + name + "%"));
        }
        statusCriteria.addOrder(Order.asc("createDate"));
        PageDto<List<TechnologyFinancial>> pageObj = new PageDto<>(--currentPage * pageSize, pageSize, statusCriteria);
        dao.pageByCriteria(pageObj);
        PageDto<List<TechnologyFinancialBaseInfoDto>> pageDto =
                new PageDto<>(pageObj.getTotalPage(), TechnologyFinancialBaseInfoDto.copy(pageObj.getT()));
        return pageDto;
    }

    private void checkTechnologyType(String category) {
        if (!TechnologyFinancial.TechnologyType.CREDIT_LOAN.value().equals(category)
                && !TechnologyFinancial.TechnologyType.MORTGAGES.value().equals(category)) {
            throw new BootException("科技金融列别错误!");
        }
    }

    @Override
    public TechnologyFinancialDto findDtoById(Long id) {
        return TechnologyFinancialDto.copy(findById(id));
    }

    @Override
    public int getPublicCount(Long userId) {
        DetachedCriteria detachedCriteria = getPublicCriteriaByUserId(userId);
        detachedCriteria.setProjection(Projections.rowCount());
        return dao.count(detachedCriteria);
    }

    /**
     * 根据用户id获取所有发布产品的离线查询对象
     *
     * @param userId {@link UserDto#getId()}
     * @return
     */
    private DetachedCriteria getPublicCriteriaByUserId(Long userId) {
        Assert.notNull(userId, "用户id不能为空!");
        return DetachedCriteria.forClass(TechnologyFinancial.class)
                .add(Restrictions.or(
                        Restrictions.and(Restrictions.eq("userId", userId),
                                Restrictions.eq("status", TechnologyFinancial.TechnologyStatus.ONLINE)),

                        Restrictions.and(Restrictions.eq("userId", userId),
                                Restrictions.eq("status", TechnologyFinancial.TechnologyStatus.APPLYING))
                ));
    }

    @Override
    public String getBestNewViewImage(Long userId) {
        DetachedCriteria publicCriteriaByUserId = getPublicCriteriaByUserId(userId);
        publicCriteriaByUserId.addOrder(Order.asc("createDate"));
        Criteria executableCriteria = publicCriteriaByUserId.getExecutableCriteria(dao.getSession());
        executableCriteria.setFirstResult(0);
        executableCriteria.setMaxResults(1);
        Object o = executableCriteria.uniqueResult();
        log.info("o==null ? {}", o == null);
        if (o != null) {
            TechnologyFinancial technologyFinancial = (TechnologyFinancial) o;
            List<TechnologyFinancialFile> viewImages = technologyFinancial.getViewImages();
            log.info("viewImages is empty ? {}", CollectionUtils.isEmpty(viewImages));
            if (!CollectionUtils.isEmpty(viewImages)) {
                TechnologyFinancialFile technologyFinancialFile = viewImages.get(viewImages.size() - 1);
                log.info("technologyFinancialFile is null {} ? ", technologyFinancialFile == null);
                if (technologyFinancialFile != null) {
                    return technologyFinancialFile.getFullPath();
                }
            }
        }
        return null;
    }

    @Override
    public List<ViewImagesVto> listIndexImages() {

        DetachedCriteria detachedCriteria = getOnlineAndOpenImage(true);
        List<TechnologyFinancial> technologyFinancials = listBydCriteria(detachedCriteria);
        List<ViewImagesVto> result = getViewImagesVtos(technologyFinancials);
        if (CollectionUtils.isEmpty(result)) {
            detachedCriteria = getOnlineAndOpenImage(false);
            technologyFinancials = listBydCriteria(detachedCriteria);
            result = getViewImagesVtos(technologyFinancials);
        }
        return result;
    }

    @Override
    public int findAppointmentCount(Long technologyFinancialId) {
        DetachedCriteria add = DetachedCriteria.forClass(TechnologyFinancialUser.class)
                .createAlias("technologyFinancial", "t").add(Restrictions.eq("t", technologyFinancialId))
                .setProjection(Projections.rowCount());
        return technologyFinancialUserService.count(add);
    }

    /**
     * 根据{@code List<TechnologyFinancial>}获取到其文件对象{@link TechnologyFinancial#getViewImages()}并且取第一张图片对象，
     * 将其转换成{@link ViewImagesVto}对象
     *
     * @param technologyFinancials {@code List<TechnologyFinancial>}科技金融对象
     * @return 文件下载对象
     */
    private List<ViewImagesVto> getViewImagesVtos(List<TechnologyFinancial> technologyFinancials) {
        List<ViewImagesVto> result = Lists.newArrayList();
        for (TechnologyFinancial technologyFinancial : technologyFinancials) {
            List<TechnologyFinancialFile> viewImages = technologyFinancial.getViewImages();
            TechnologyFinancialFile technologyFinancialFile = viewImages.get(0);
            result.add(new ViewImagesVto(technologyFinancialFile.getFullPath()));
        }
        return result;
    }

    /**
     * 获取{@link DetachedCriteria}离线查询条件对象,查找的是线上的并且createDate升序的.
     * 如果传递了needOpenImage,则添加条件为openImage为true的并且只查询viewImages属性
     *
     * @param needOpenImage 是否需要过滤首页开启图片的标识
     * @return {@link DetachedCriteria}
     */
    private DetachedCriteria getOnlineAndOpenImage(boolean needOpenImage) {
        DetachedCriteria detachedCriteria = getDetachedCriteria(TechnologyFinancial.TechnologyStatus.ONLINE.value())
                .addOrder(Order.asc("createDate"));
        if (needOpenImage) {
            detachedCriteria.add(Restrictions.eq("openImage", new Boolean(true)));
        }
        detachedCriteria.setProjection(Projections.property("viewImages"));
        return detachedCriteria;
    }

    /**
     * 根据状态查找{@link TechnologyFinancialDto}列表
     *
     * @param status 详情见{@link TechnologyFinancial.TechnologyStatus#values()}
     * @return {@code List<TechnologyFinancialDto>}
     */
    private List<TechnologyFinancialDto> listByStatus(int status) {
        DetachedCriteria statusCriteria = getDetachedCriteria(status);
        return TechnologyFinancialDto.copy(listBydCriteria(statusCriteria));
    }

    private DetachedCriteria getDetachedCriteria(int status) {
        return getStatusCriteria(status)
                .add(Restrictions.eq("userId", Application.getCurrentUser().getId()));
    }

    private DetachedCriteria getStatusCriteria(int status) {
        return DetachedCriteria.forClass(TechnologyFinancial.class)
                .add(Restrictions.eq("status", status));
    }

    /**
     * 从{@link TechnologyFinancialVto}对象提取非基本对象的参数，并且设置到{@link TechnologyFinancial}对象中
     *
     * @param technologyFinancialVto {@link TechnologyFinancialVto} 前端接收对象
     * @param technologyFinancial    {@link TechnologyFinancial}实体保存对象
     */
    private void checkProcessData(TechnologyFinancialVto technologyFinancialVto, TechnologyFinancial technologyFinancial) {
        //关联存储过的文件对象
        List<ViewImagesVto> viewImages = technologyFinancialVto.getViewImages();
        Assert.notEmpty(viewImages, "展示图片为必选项!");
        for (ViewImagesVto file : viewImages) {
            TechnologyFinancialFile fileObj = technologyFinancialFileService.findByPath(file.getFullPath());
            if (fileObj == null) {
                throw new BootException("所选文件已经被删除!");
            }
//            fileObj.setTechnologyFinancial(technologyFinancial);
            technologyFinancial.getViewImages().add(fileObj);
            if (technologyFinancial.getViewImages().size() > 6) {
                throw new BootException("只支持传递6张展示图片!");
            }
        }

        //贷款期限
        LoanTimeLimitVto loanTimeLimit = technologyFinancialVto.getLoanTimeLimit();
        Assert.notNull(loanTimeLimit, "贷款期限为必选项！");
        TechnologyLoanDate technologyLoanDate = dao.findSingleByProperty(TechnologyLoanDate.class, "id", loanTimeLimit.getId());
        if (technologyLoanDate == null) {
            throw new BootException("错误的贷款期限选项!");
        }
        technologyFinancial.setLoanTimeLimit(technologyLoanDate);

        //贷款额度
        LoanAmountVto loanAmount = technologyFinancialVto.getLoanAmount();
        Assert.notNull(loanAmount, "贷款额度为必选项！");
        TechnologyLoanAmount technologyLoanAmount = dao.findSingleByProperty(TechnologyLoanAmount.class, "id", loanAmount.getId());
        if (technologyLoanAmount == null) {
            throw new BootException("错误的贷款额度选项!");
        }
        technologyFinancial.setLoanAmount(technologyLoanAmount);

        List<TechnologyLoanTypeVto> technologyLoanTypes = technologyFinancialVto.getTechnologyLoanTypes();
        Assert.notEmpty(technologyLoanTypes, "可抵押类型为必选项!");
        for (TechnologyLoanTypeVto type : technologyLoanTypes) {
            TechnologyLoanType technologyLoanType = dao.findSingleByProperty(TechnologyLoanType.class, "id", type.getId());
            if (technologyLoanType == null) {
                throw new BootException("错误的可抵押类型选项!");
            }
            technologyFinancial.getTechnologyLoanTypes().add(technologyLoanType);
        }


        String endDate = technologyFinancialVto.getApplyEndDate();
        if (endDate != null) {
            try {
                Date parse = DateUtil.parse(endDate);
                technologyFinancial.setApplyEndDate(parse);
            } catch (ParseException e) {
                throw new BootException("结束申请时间格式错误!!");
            }
        }

        String category = technologyFinancialVto.getCategory();
        boolean notTrue = !TechnologyFinancial.TechnologyType.CREDIT_LOAN.value().equals(category) &&
                !TechnologyFinancial.TechnologyType.MORTGAGES.value().equals(category);
        if (notTrue) {
            throw new BootException("不支持的贷款类别!");
        }
    }
}
