package xinrui.cloud.service.impl;

import com.sun.org.apache.bcel.internal.generic.NEW;
import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.Restrictions;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import xinrui.cloud.domain.*;
import xinrui.cloud.domain.dto.*;
import xinrui.cloud.service.TechnologyFinancialFileService;
import xinrui.cloud.service.TechnologyFinancialService;

import java.util.List;


@Service
public class TechnologyFinancialServiceImpl extends BaseServiceImpl implements xinrui.cloud.service.TechnologyFinancialService {

    @Autowired
    TechnologyFinancialFileService technologyFinancialFileService;

    @Override
    public List<TechnologyLoanDateDto> dates() {
        return TechnologyLoanDateDto.copy(dao.listObjBy(TechnologyLoanDate.class));
    }

    @Override
    public List<TechnologyLoanTypeDto> types() {
        return TechnologyLoanTypeDto.copy(dao.listObjBy(TechnologyLoanType.class));
    }

    @Override
    public List<TechnologyLoanAmountDto> amounts() {
        return TechnologyLoanAmountDto.copy(dao.listObjBy(TechnologyLoanAmount.class));
    }

    @Override
    public TechnologyFinancialDto saveByDto(TechnologyFinancialDto technologyFinancialDto) {
        TechnologyFinancial technologyFinancial = new TechnologyFinancial();
        BeanUtils.copyProperties(technologyFinancialDto, technologyFinancial, "viewImages", "loanTimeLimit"
                , "loanAmount", "technologyApplyConditions", "createDate", "technologyUsualProblems");

        //关联存储过的文件对象
        List<TechnologyFinancialFileDto> viewImages = technologyFinancialDto.getViewImages();
        for (TechnologyFinancialFileDto file : viewImages) {
            TechnologyFinancialFile fileObj = technologyFinancialFileService.findByPath(file.getFullPath());
            if (fileObj != null) {
                technologyFinancial.getViewImages().add(fileObj);
            }
        }

        TechnologyLoanDateDto loanTimeLimit = technologyFinancialDto.getLoanTimeLimit();
        if(loanTimeLimit!=null){
            TechnologyLoanDate technologyLoanDate=dao.findSingleByProperty(TechnologyLoanDate.class,"id",loanTimeLimit.getId());
            if(technologyLoanDate!=null){
                technologyFinancial.setLoanTimeLimit(technologyLoanDate);
            }
        }

        TechnologyLoanAmountDto loanAmount = technologyFinancialDto.getLoanAmount();
        if(loanAmount!=null){
            TechnologyLoanAmount technologyLoanAmount=dao.findSingleByProperty(TechnologyLoanAmount.class,"id",loanAmount.getId());
            if(technologyLoanAmount!=null){
                technologyFinancial.setLoanAmount(technologyLoanAmount);
            }
        }

//        technologyFinancial.setViewImages();
        return null;
    }
}
