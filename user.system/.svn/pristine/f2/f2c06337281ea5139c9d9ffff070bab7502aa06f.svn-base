package liuzhuomin.cloud.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import liuzhuomin.cloud.DTO.TokenDto;
import liuzhuomin.cloud.config.EhcacheComponent;
import liuzhuomin.cloud.dto.ResultDto;
import net.sf.ehcache.Cache;
import net.sf.ehcache.Element;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.security.oauth2.provider.OAuth2Authentication;
import org.springframework.util.Assert;
import org.springframework.util.CollectionUtils;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.validation.constraints.NotNull;
import java.util.List;
import java.util.Set;

/**
 * <B>Title:</B>AuthenticationController</br>
 * <B>Description:</B>  </br>
 * <B>Copyright: </B>Copyright (c) 2019 </br>
 *
 * @author liuliuliu
 * @version 1.0
 * @date2019/6/25 16:11
 */
@RestController
@RequestMapping("oauth")
@Api("用户授权验证相关接口")
public class AuthenticationController {

    @Autowired
    EhcacheComponent ehcacheComponent;

    private final static Logger LOGGER= LoggerFactory.getLogger(AuthenticationController.class);

    @ApiOperation("通过token令牌获取用户相关简略信息,包含用户名和角色")
    @RequestMapping(value = "user", produces = "application/json")
    public TokenDto user(OAuth2Authentication auth2Authentication) {
        Object principal = auth2Authentication.getUserAuthentication().getPrincipal();
        Set<String> strings = AuthorityUtils.authorityListToSet(auth2Authentication.getUserAuthentication().getAuthorities());
        LOGGER.info("princicpal{}",principal);
        return new TokenDto(principal, strings);
    }

    /**
     *检查当前的token是否有效，
     * @param token  用户的access_token
     * @return  {@link ResultDto}
     */
    @PostMapping("check/{token}")
    public ResultDto<?> checkOutToken(@PathVariable("token") @NotNull String token){
        Cache defaultTokenCache = ehcacheComponent.getDefaultTokenCache();
        Assert.notNull(defaultTokenCache,"服务器故障");
        List keys = defaultTokenCache.getKeys();
        for(Object key:keys){
            System.out.println("key:"+key.toString());
            System.out.println("token:"+token);
            if(token.equals(key.toString()))
                return ResultDto.error(401,"身份验证失败!");
        }
        return  ResultDto.success();
    }



}
